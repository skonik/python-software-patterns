<!doctype html><html lang=en data-mode=dark><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=theme content="Color Your World -- gitlab.com/rmaguiar/hugo-theme-color-your-world"><title>Webhook handlers via decorators</title><meta name=robots content="index follow"><meta name=referrer content="no-referrer-when-downgrade"><link rel=canonical href=https://skonik.github.io/python-software-patterns/posts/webhook-handler/><meta property="og:site_name" content="Python Software Patterns"><meta property="og:title" content="Webhook handlers via decorators"><meta property="og:url" content="https://skonik.github.io/python-software-patterns/posts/webhook-handler/"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-05-27"><meta property="article:modified_time" content="2021-05-27"><meta property="og:updated_time" content="2021-05-27"><meta name=theme-color content="#222"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebSite","@id":"https:\/\/skonik.github.io\/python-software-patterns"},"headline":"Webhook handlers via decorators","description":"","url":"https:\/\/skonik.github.io\/python-software-patterns\/posts\/webhook-handler\/","inLanguage":"en","datePublished":"2021-05-27","dateModified":"2021-05-27","wordCount":"200","publisher":{"@type":"Person","name":""},"author":{"@type":"Person","name":""}}</script><link rel=stylesheet href=/python-software-patterns/css/main.min.css><noscript><meta name=theme-color content="#dd587c" media="(prefers-color-scheme: dark)"><meta name=theme-color content="#225670" media="(prefers-color-scheme: light)"><style>html{--accent:#dd587c}.req-js{display:none}</style></noscript><link rel=preload href=/python-software-patterns/fonts/open-sans-v17-latin-700.woff as=font crossorigin=anonymous><link rel=preload href=/python-software-patterns/fonts/open-sans-v17-latin-700.woff2 as=font crossorigin=anonymous><link rel=preload href=/python-software-patterns/fonts/open-sans-v17-latin-italic.woff as=font crossorigin=anonymous><link rel=preload href=/python-software-patterns/fonts/open-sans-v17-latin-italic.woff2 as=font crossorigin=anonymous><link rel=preload href=/python-software-patterns/fonts/open-sans-v17-latin-regular.woff as=font crossorigin=anonymous><link rel=preload href=/python-software-patterns/fonts/open-sans-v17-latin-regular.woff2 as=font crossorigin=anonymous><link rel=preload href=/python-software-patterns/fonts/oswald-v29-latin-700.woff as=font crossorigin=anonymous><link rel=preload href=/python-software-patterns/fonts/oswald-v29-latin-700.woff2 as=font crossorigin=anonymous><script>'use strict';const PREFERS_LIGHT=window.matchMedia('(prefers-color-scheme: light)'),PREFERS_DARK=window.matchMedia('(prefers-color-scheme: dark)'),ROOT=document.documentElement,SHEET=document.documentElement.style,META_THEME_COLOR=document.querySelector('meta[name=theme-color]');function setDark(){ROOT.dataset.mode='dark'}function setLight(){ROOT.dataset.mode='light'}localStorage.getItem('isDark')=='true'?setDark():localStorage.getItem('isDark')=='false'?setLight():PREFERS_DARK.matches?setDark():PREFERS_LIGHT.matches&&setLight();function getAccent(){var a;return ROOT.dataset.mode==='dark'?localStorage.getItem('darkAccent')===null?(a="#dd587c"):(a=localStorage.getItem('darkAccent')):ROOT.dataset.mode==='light'&&(localStorage.getItem('lightAccent')===null?(a="#225670"):(a=localStorage.getItem('lightAccent'))),a}var activeAccent=getAccent();SHEET.setProperty('--accent',activeAccent),META_THEME_COLOR.setAttribute('content',activeAccent);function updateAccent(){var a=getAccent();SHEET.setProperty('--accent',a),PALETTE.value=a,META_THEME_COLOR.setAttribute('content',a)}document.addEventListener('DOMContentLoaded',function(){PALETTE.value=activeAccent;function a(){document.body.style.transition=document.querySelector('header').style.transition=document.querySelector('footer').style.transition='background-color .3s ease, color .3s ease'}function c(){a(),ROOT.dataset.mode=='light'?(setDark(),localStorage.setItem('isDark','true')):(setLight(),localStorage.setItem('isDark','false')),updateAccent()}function b(){a(),PREFERS_LIGHT.matches?(setLight(),localStorage.setItem('isDark','false')):PREFERS_DARK.matches&&(setDark(),localStorage.setItem('isDark','true')),updateAccent()}PREFERS_LIGHT.addListener(b),PREFERS_DARK.addListener(b),document.querySelector('footer button').addEventListener('click',c)})</script></head><body><header><a href=/python-software-patterns>Python Software Patterns</a></header><div class=filler><main><article><header><h1>Webhook handlers via decorators</h1><p>Published on <time datetime=2021-05-27>2021-05-27</time></p></header><h3 id=problem><a class=anchor href=#problem title='Anchor for "Problem".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Problem</h3><p>You have an external system(e.g payment gateway) sending events onto your backend http endpoint.
There are several types of events have to be processed in different ways.</p><p><img loading=lazy src=https://skonik.github.io/python-software-patterns/webhook-handler/images/webhook_handlers/external_system.png alt="Webhook image"></p><p>How to organize the code?</p><h3 id=possible-solution><a class=anchor href=#possible-solution title='Anchor for "Possible solution".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Possible solution</h3><p>Move processing of particular types into separate functions and register them via decorators.</p><p>Create a decorator that consumes parameter(e.g event) and stores a function in the dict or other container.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps

event_handlers <span style=color:#f92672>=</span> dict()  <span style=color:#75715e># Dict  to store event -&gt; func mappings</span>


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handler</span>(event):

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorator</span>(func):
        event_handlers[event] <span style=color:#f92672>=</span> func

        <span style=color:#a6e22e>@wraps</span>(func)
        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(data):

            result <span style=color:#f92672>=</span> func(data)

            <span style=color:#66d9ef>return</span> result

        <span style=color:#66d9ef>return</span> wrapper

    <span style=color:#66d9ef>return</span> decorator

</code></pre></div><p>Write functions responsible for processing specific events and hang decorators on them.
Write a function getting event handlers functions and call the function.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>

<span style=color:#a6e22e>@handler</span>(event<span style=color:#f92672>=</span>PayPalEvent<span style=color:#f92672>.</span>PAYMENT_SALE_COMPLETED)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>activate_subscription</span>(data):
    resource <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#39;resource&#39;</span>]
    <span style=color:#f92672>...</span>
    <span style=color:#75715e># Subscription activation logic</span>
    <span style=color:#66d9ef>pass</span>


<span style=color:#a6e22e>@handler</span>(event<span style=color:#f92672>=</span>PayPalEvent<span style=color:#f92672>.</span>CUSTOMER_DISPUTE_CREATED)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_dispute</span>(data):
    resource <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#39;resource&#39;</span>]
    <span style=color:#f92672>...</span>
    <span style=color:#75715e># Create dispute logic</span>
    <span style=color:#66d9ef>pass</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>process_not_handled</span>(data):
    write_logs(<span style=color:#f92672>...</span>)
    <span style=color:#f92672>...</span>
    <span style=color:#75715e># Processing not handled event logic</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>process</span>(event: str, data: dict) <span style=color:#f92672>-&gt;</span> None:
    func <span style=color:#f92672>=</span> event_handlers<span style=color:#f92672>.</span>get(event, process_not_handled)
    func(data)

</code></pre></div><p>Parse event in request and call processing function.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Webhook</span>(APIView):
    permission_classes <span style=color:#f92672>=</span> [permissions<span style=color:#f92672>.</span>AllowAny]

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>post</span>(self, request):
        validate_request(request)
        event <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;event_type&#39;</span>)
        handlers<span style=color:#f92672>.</span>process(event<span style=color:#f92672>=</span>event, data<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>data)

        <span style=color:#66d9ef>return</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_200_OK)
</code></pre></div><h3 id=additional-links><a class=anchor href=#additional-links title='Anchor for "Additional links".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Additional links</h3><p>Open source in-library use example: <a href=https://github.com/dj-stripe/dj-stripe/blob/master/djstripe/event_handlers.py>dj-stripe</a></p></article></main></div><footer><section class=req-js><button class=outline-dashed title="Change to light/dark mode."><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><use xlink:href="#adjust"/></svg></button><input class=outline-dashed type=color list=presets value=#dd587c title="Change accent color." aria-label="Change accent color."><datalist id=presets><option value=#225670><option value=#dd587c></datalist></section></footer><svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" aria-hidden="true"><symbol viewBox="0 0 512 512" id="adjust"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></symbol><symbol viewBox="0 0 448 512" id="hashtag"><path d="M440.667 182.109l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l14.623-81.891C377.123 38.754 371.468 32 363.997 32h-40.632a12 12 0 00-11.813 9.891L296.175 128H197.54l14.623-81.891C213.477 38.754 207.822 32 200.35 32h-40.632a12 12 0 00-11.813 9.891L132.528 128H53.432a12 12 0 00-11.813 9.891l-7.143 40C33.163 185.246 38.818 192 46.289 192h74.81L98.242 320H19.146a12 12 0 00-11.813 9.891l-7.143 40C-1.123 377.246 4.532 384 12.003 384h74.81L72.19 465.891C70.877 473.246 76.532 480 84.003 480h40.632a12 12 0 0011.813-9.891L151.826 384h98.634l-14.623 81.891C234.523 473.246 240.178 480 247.65 480h40.632a12 12 0 0011.813-9.891L315.472 384h79.096a12 12 0 0011.813-9.891l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l22.857-128h79.096a12 12 0 0011.813-9.891zM261.889 320h-98.634l22.857-128h98.634l-22.857 128z"/></symbol></svg><script>'use strict';const PALETTE=document.querySelector('footer input');PALETTE.onchange=function(){const a=PALETTE.value;SHEET.setProperty('--accent',a),ROOT.dataset.mode==='light'?localStorage.setItem('lightAccent',a):localStorage.setItem('darkAccent',a),updateAccent()}</script></body></html>